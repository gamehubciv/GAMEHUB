<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü§ñ LuckyJet Predictor - Version Premium</title>
    
    <!-- Import Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
        import { 
            getFirestore,
            collection,
            query,
            getDocs,
            where
        } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
        
        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDhySV3lXOlCQ8fMIYRlzs0YpMg6MZ_Ixo",
            authDomain: "gamehub-e45ea.firebaseapp.com",
            projectId: "gamehub-e45ea",
            storageBucket: "gamehub-e45ea.firebasestorage.app",
            messagingSenderId: "609288909968",
            appId: "1:609288909968:web:45f3716ce6b2d4970d1415"
        };

        // Initialiser Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Variables globales pour la licence
        let userLicense = null;
        let licenseCheckInterval = null;
        let isLicenseValid = false;
        let botIntervals = [];
        
        // V√©rifier l'√©tat d'authentification et la licence
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // V√©rifier si l'email est v√©rifi√©
                if (!user.emailVerified) {
                    showLicenseMessage("Email non v√©rifi√©", "Veuillez v√©rifier votre email pour acc√©der au bot", true);
                    return;
                }
                
                console.log("Utilisateur connect√©:", user.uid);
                
                // V√©rifier la licence pour LuckyJet
                await checkUserLicense(user.uid);
                
                // D√©marrer la v√©rification p√©riodique de la licence
                startLicenseCheck();
            } else {
                // Rediriger vers la page de connexion si non connect√©
                showLicenseMessage("Non connect√©", "Vous devez √™tre connect√© pour utiliser ce bot", true);
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 3000);
            }
        });

        // V√©rifier la licence de l'utilisateur
        async function checkUserLicense(userId) {
            console.log("V√©rification de la licence pour l'utilisateur:", userId);
            
            try {
                const userPurchasesRef = collection(db, 'users', userId, 'purchases');
                
                // Recherche des licences pour 'luckyjet'
                const q = query(
                    userPurchasesRef,
                    where('gameId', '==', 'luckyjet')
                );
                
                console.log("Ex√©cution de la requ√™te Firestore...");
                const querySnapshot = await getDocs(q);
                console.log("R√©sultats trouv√©s:", querySnapshot.size);
                
                if (querySnapshot.empty) {
                    console.log("Aucune licence trouv√©e pour 'luckyjet'");
                    showLicenseMessage("Licence non trouv√©e", "Vous n'avez pas achet√© LuckyJet Predictor", true);
                    isLicenseValid = false;
                    return;
                }
                
                let activeLicense = null;
                let latestLicense = null;
                let now = new Date();
                
                // Parcourir tous les r√©sultats
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    console.log("Document trouv√©:", data);
                    
                    const expirationDate = new Date(data.expirationDate);
                    const purchaseDate = new Date(data.purchaseDate);
                    
                    console.log("Statut:", data.status);
                    console.log("Date d'expiration:", expirationDate);
                    console.log("Date d'achat:", purchaseDate);
                    
                    // V√©rifier si la licence est active ET non expir√©e
                    if (data.status === 'active' && expirationDate > now) {
                        if (!activeLicense || purchaseDate > new Date(activeLicense.purchaseDate)) {
                            activeLicense = {
                                id: doc.id,
                                ...data,
                                expirationDate: expirationDate,
                                purchaseDate: purchaseDate,
                                remainingTime: expirationDate - now
                            };
                        }
                    }
                    
                    // Garder la licence la plus r√©cente m√™me si expir√©e (pour debug)
                    if (!latestLicense || purchaseDate > new Date(latestLicense.purchaseDate)) {
                        latestLicense = {
                            id: doc.id,
                            ...data,
                            expirationDate: expirationDate,
                            purchaseDate: purchaseDate
                        };
                    }
                });
                
                if (activeLicense) {
                    // Licence active trouv√©e
                    userLicense = activeLicense;
                    isLicenseValid = true;
                    
                    const remainingHours = Math.floor(userLicense.remainingTime / (1000 * 60 * 60));
                    const remainingMinutes = Math.floor((userLicense.remainingTime % (1000 * 60 * 60)) / (1000 * 60));
                    
                    console.log("Licence active trouv√©e:", userLicense);
                    console.log("Temps restant:", remainingHours + "h " + remainingMinutes + "m");
                    
                    showLicenseMessage(
                        "Licence active ‚úì", 
                        `Temps restant: ${remainingHours}h ${remainingMinutes}m`, 
                        false
                    );
                    
                    // Masquer le message apr√®s 3 secondes
                    setTimeout(() => {
                        hideLicenseMessage();
                    }, 3000);
                    
                    // D√©marrer le bot
                    startBot();
                } else if (latestLicense) {
                    // Afficher les d√©tails de la licence trouv√©e (pour debug)
                    console.log("Licence trouv√©e mais inactive ou expir√©e:", latestLicense);
                    
                    const now = new Date();
                    const expirationDate = new Date(latestLicense.expirationDate);
                    const isExpired = expirationDate < now;
                    const isInactive = latestLicense.status !== 'active';
                    
                    let message = "Licence ";
                    if (isInactive) message += "inactive";
                    if (isExpired) message += isInactive ? " et expir√©e" : "expir√©e";
                    
                    showLicenseMessage(
                        message,
                        `Date d'expiration: ${expirationDate.toLocaleDateString()} ${expirationDate.toLocaleTimeString()}`,
                        true
                    );
                    
                    isLicenseValid = false;
                } else {
                    console.log("Aucune licence valide trouv√©e");
                    showLicenseMessage("Licence non valide", "Votre licence n'est pas active ou a expir√©", true);
                    isLicenseValid = false;
                }
                
            } catch (error) {
                console.error('Erreur lors de la v√©rification de la licence:', error);
                console.error('D√©tails de l\'erreur:', error.message);
                console.error('Stack trace:', error.stack);
                
                // Afficher un message d'erreur d√©taill√©
                showLicenseMessage(
                    "Erreur technique", 
                    "Impossible de v√©rifier votre licence. Veuillez r√©essayer.", 
                    true
                );
                isLicenseValid = false;
            }
        }

        // D√©marrer la v√©rification p√©riodique de la licence
        function startLicenseCheck() {
            if (licenseCheckInterval) {
                clearInterval(licenseCheckInterval);
            }
            
            // V√©rifier toutes les 30 secondes
            licenseCheckInterval = setInterval(async () => {
                const user = auth.currentUser;
                if (user && isLicenseValid) {
                    await checkUserLicense(user.uid);
                }
            }, 30000);
        }

        // Afficher un message de licence
        function showLicenseMessage(title, message, isError = false) {
            const existingMessage = document.getElementById('licenseMessage');
            if (existingMessage) {
                existingMessage.remove();
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.id = 'licenseMessage';
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: ${isError ? 'rgba(220, 53, 69, 0.95)' : 'rgba(40, 167, 69, 0.95)'};
                color: white;
                padding: 15px 30px;
                border-radius: 8px;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                animation: slideIn 0.3s ease;
                text-align: center;
                max-width: 90%;
                backdrop-filter: blur(10px);
                border: 1px solid ${isError ? 'rgba(220, 53, 69, 0.3)' : 'rgba(40, 167, 69, 0.3)'};
            `;
            
            messageDiv.innerHTML = `
                <strong style="font-size: 16px;">${title}</strong><br>
                <span style="font-size: 14px;">${message}</span>
                ${isError ? '<br><button id="goToStore" style="margin-top: 10px; padding: 8px 16px; background: white; color: #dc3545; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">Acheter une licence</button>' : ''}
            `;
            
            document.body.appendChild(messageDiv);
            
            if (isError) {
                const goToStoreBtn = document.getElementById('goToStore');
                if (goToStoreBtn) {
                    goToStoreBtn.addEventListener('click', () => {
                        window.location.href = 'accueil.html';
                    });
                }
                
                // Rediriger automatiquement apr√®s 5 secondes si licence invalide
                setTimeout(() => {
                    if (!isLicenseValid) {
                        window.location.href = 'accueil.html';
                    }
                }, 5000);
            }
        }

        // Masquer le message de licence
        function hideLicenseMessage() {
            const messageDiv = document.getElementById('licenseMessage');
            if (messageDiv) {
                messageDiv.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.parentNode.removeChild(messageDiv);
                    }
                }, 300);
            }
        }

        // Arr√™ter le bot
        function stopBot() {
            console.log("Arr√™t du bot...");
            
            // Arr√™ter tous les intervalles du bot
            botIntervals.forEach(interval => {
                clearInterval(interval);
            });
            botIntervals = [];
            
            // Arr√™ter les autres intervalles globaux
            if (window.flyingCheckInterval) {
                clearInterval(window.flyingCheckInterval);
                window.flyingCheckInterval = null;
            }
            
            if (window.gameStateCheckInterval) {
                clearInterval(window.gameStateCheckInterval);
                window.gameStateCheckInterval = null;
            }
            
            if (window.validationInterval) {
                clearInterval(window.validationInterval);
                window.validationInterval = null;
            }
            
            if (window.predictionTimeout) {
                clearTimeout(window.predictionTimeout);
                window.predictionTimeout = null;
            }
            
            // D√©sactiver le bot
            window.isPredictionActive = false;
            
            // Afficher un message d'arr√™t
            const statusIndicator = document.getElementById('statusIndicator');
            if (statusIndicator) {
                statusIndicator.innerHTML = `<i class="fas fa-stop-circle"></i> Bot arr√™t√© - Licence expir√©e`;
                statusIndicator.style.color = '#dc3545';
            }
            
            showLicenseMessage("Licence expir√©e", "Votre temps est √©puis√©. Achetez une nouvelle licence.", true);
        }

        // D√©marrer le bot (sera appel√© apr√®s v√©rification de la licence)
        function startBot() {
            console.log("D√©marrage du bot...");
            
            // Initialiser le bot
            if (window.createStars) window.createStars();
            if (window.updateCurrentTime) window.updateCurrentTime();
            
            // Mettre √† jour l'heure toutes les minutes
            botIntervals.push(setInterval(window.updateCurrentTime, 60000));
            
            // Mettre √† jour le statut
            const statusIndicator = document.getElementById('statusIndicator');
            if (statusIndicator) {
                statusIndicator.innerHTML = `<i class="fas fa-sync fa-spin"></i> Bot actif - Licence valide`;
            }
            
            console.log("Bot d√©marr√© avec succ√®s");
        }

        // Fonction pour v√©rifier la licence avant chaque op√©ration
        window.checkLicenseBeforeOperation = function() {
            if (!isLicenseValid) {
                console.log("Licence invalide - arr√™t de l'op√©ration");
                stopBot();
                return false;
            }
            return true;
        };

        // Exposer les variables globalement
        window.isLicenseValid = isLicenseValid;
        window.stopBot = stopBot;
    </script>
    
    <!-- Styles et scripts -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
    /* Th√®me LuckyJet */
    :root {
        --primary-color: #8a00e1;
        --primary-dark: #6b00b3;
        --secondary-color: #ff69b4;
        --success-color: #00FF00;
        --warning-color: #ffcc00;
        --danger-color: #ff5555;
        --bg-color: #141414;
        --card-bg: #1a1a2e;
        --text-color: #ffffff;
    }

    body {
        background-color: var(--bg-color);
        background-image: radial-gradient(circle at 50% 50%, #1a1a2e 0%, #121212 100%);
        color: var(--text-color);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        min-height: 100vh;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: .5; }
    }
    .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }

    @keyframes bounce {
        0%, 100% { transform: translateY(-25%); }
        50% { transform: translateY(0); }
    }
    .animate-bounce { animation: bounce 1s infinite; }

    @keyframes fadeIn {
        from { opacity: 0; transform: scale(0.8); }
        to { opacity: 1; transform: scale(1); }
    }

    @keyframes slideIn {
        from { transform: translateX(-50%) translateY(-20px); opacity: 0; }
        to { transform: translateX(-50%) translateY(0); opacity: 1; }
    }
    
    @keyframes slideOut {
        from { transform: translateX(-50%) translateY(0); opacity: 1; }
        to { transform: translateX(-50%) translateY(-20px); opacity: 0; }
    }

    @keyframes float {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-10px); }
    }
    
    .floating {
        animation: float 3s ease-in-out infinite;
    }
    
    @keyframes glow {
        0% { box-shadow: 0 0 5px rgba(138, 0, 225, 0.5); }
        50% { box-shadow: 0 0 20px rgba(138, 0, 225, 0.8); }
        100% { box-shadow: 0 0 5px rgba(138, 0, 225, 0.5); }
    }
    
    .glowing {
        animation: glow 2s infinite;
    }
    
    @keyframes jetGlow {
        0% { box-shadow: 0 0 10px rgba(138, 0, 225, 0.5), 0 0 20px rgba(255, 105, 180, 0.3); }
        50% { box-shadow: 0 0 20px rgba(138, 0, 225, 0.8), 0 0 40px rgba(255, 105, 180, 0.6); }
        100% { box-shadow: 0 0 10px rgba(138, 0, 225, 0.5), 0 0 20px rgba(255, 105, 180, 0.3); }
    }
    
    .jet-glowing {
        animation: jetGlow 2s infinite;
    }
    
    /* Composants sp√©cifiques */
    .coefficient-badge {
        display: inline-block;
        background: linear-gradient(145deg, var(--primary-color), var(--primary-dark));
        color: white;
        border-radius: 9999px;
        padding: 0.25rem 0.75rem;
        font-size: 0.875rem;
        margin: 0.25rem;
        animation: fadeIn 0.3s ease-out;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    .auto-fetch-container {
        background: linear-gradient(145deg, rgba(138, 0, 225, 0.1), rgba(107, 0, 179, 0.05));
        border-radius: 12px;
        padding: 15px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        border: 1px solid rgba(138, 0, 225, 0.2);
    }
    
    .history-item {
        transition: all 0.3s ease;
        background: var(--card-bg);
        border: 1px solid rgba(138, 0, 225, 0.2);
    }
    
    .history-item:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 12px rgba(138, 0, 225, 0.2);
        border-color: rgba(138, 0, 225, 0.4);
    }
    
    .stats-card {
        background: var(--card-bg);
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        padding: 1rem;
        border: 1px solid rgba(138, 0, 225, 0.2);
    }
    
    .robot-header {
        background: linear-gradient(135deg, var(--primary-dark), var(--primary-color));
        color: white;
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 1rem;
        border: 1px solid rgba(138, 0, 225, 0.3);
        box-shadow: 0 4px 15px rgba(138, 0, 225, 0.3);
    }
    
    .feature-card {
        background: rgba(138, 0, 225, 0.1);
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 0.75rem;
        border: 1px solid rgba(138, 0, 225, 0.3);
    }
    
    .duplicate-warning {
        background-color: rgba(255, 204, 0, 0.2);
        color: #ffcc00;
        border: 1px solid rgba(255, 204, 0, 0.3);
        padding: 8px;
        border-radius: 6px;
        font-size: 0.85rem;
        text-align: center;
        margin-top: 10px;
        animation: fadeIn 0.5s ease-out;
    }
    
    .dashboard-card {
        background: var(--card-bg);
        border-radius: 12px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        overflow: hidden;
        transition: transform 0.3s ease;
        padding: 1rem;
        border: 1px solid rgba(138, 0, 225, 0.2);
    }
    
    .dashboard-card:hover {
        transform: translateY(-3px);
        border-color: rgba(138, 0, 225, 0.4);
    }
    
    .gradient-btn {
        background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
        color: white;
        border: none;
        border-radius: 10px;
        padding: 10px 20px;
        font-weight: 600;
        transition: all 0.3s ease;
        font-size: 0.9rem;
        box-shadow: 0 4px 6px rgba(138, 0, 225, 0.3);
    }
    
    .gradient-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(138, 0, 225, 0.4);
    }
    
    .status-badge {
        display: inline-flex;
        align-items: center;
        padding: 3px 10px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 500;
    }
    
    .status-pending {
        background: rgba(255, 204, 0, 0.2);
        color: #ffcc00;
    }
    
    .status-success {
        background: rgba(0, 255, 0, 0.2);
        color: #00FF00;
    }
    
    .status-failed {
        background: rgba(255, 85, 85, 0.2);
        color: #ff5555;
    }
    
    .validation-container {
        margin-top: 1.2rem;
        padding: 1rem;
        background: rgba(138, 0, 225, 0.1);
        border-radius: 10px;
        border: 1px solid rgba(138, 0, 225, 0.3);
    }
    
    .validation-status {
        padding: 0.6rem;
        border-radius: 6px;
        margin-top: 0.4rem;
        font-size: 0.85rem;
        text-align: center;
        font-weight: 500;
    }
    
    .validation-pending {
        background-color: rgba(255, 204, 0, 0.2);
        color: #ffcc00;
        border: 1px solid rgba(255, 204, 0, 0.3);
    }
    
    .validation-success {
        background-color: rgba(0, 255, 0, 0.2);
        color: #00FF00;
        border: 1px solid rgba(0, 255, 0, 0.3);
    }
    
    .validation-failed {
        background-color: rgba(255, 85, 85, 0.2);
        color: #ff5555;
        border: 1px solid rgba(255, 85, 85, 0.3);
    }
    
    .round-badge {
        display: inline-block;
        background: linear-gradient(145deg, var(--primary-dark), var(--primary-color));
        color: white;
        border-radius: 8px;
        padding: 0.5rem 1.2rem;
        font-weight: bold;
        font-size: 1.1rem;
        margin: 0.3rem;
        box-shadow: 0 4px 6px rgba(138, 0, 225, 0.2);
        transition: all 0.3s ease;
    }
    
    .confidence-level {
        height: 10px;
        border-radius: 5px;
        background: linear-gradient(to right, #ff5555, #ffcc00, #00FF00);
    }
    
    .confidence-fill {
        height: 100%;
        border-radius: 5px;
        background: var(--primary-color);
        transition: width 1s ease-in-out;
    }
    
    /* √âtoiles en arri√®re-plan */
    .stars {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        pointer-events: none;
    }
    
    .star {
        position: absolute;
        background-color: white;
        border-radius: 50%;
        animation: twinkle var(--duration) infinite ease-in-out;
        opacity: var(--opacity);
    }
    
    @keyframes twinkle {
        0%, 100% { opacity: var(--opacity); }
        50% { opacity: 0.2; }
    }
    
    /* Optimisations mobile */
    @media (max-width: 768px) {
        .container {
            padding-left: 0.75rem;
            padding-right: 0.75rem;
            max-width: 100%;
        }
        
        .robot-header {
            padding: 0.75rem;
            margin-bottom: 0.75rem;
        }
        
        .robot-header h1 {
            font-size: 1.5rem;
        }
        
        .dashboard-card {
            padding: 0.75rem;
            margin-bottom: 0.75rem;
        }
        
        .grid-cols-1 {
            gap: 0.75rem;
        }
        
        .grid-cols-1.md\:grid-cols-2 {
            gap: 0.75rem;
        }
        
        .feature-card {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
        }
        
        .stats-card {
            padding: 0.75rem;
        }
        
        .gradient-btn {
            padding: 8px 16px;
            font-size: 0.85rem;
        }
        
        .auto-fetch-container {
            padding: 12px;
        }
    }
    
    @media (max-width: 480px) {
        .container {
            padding-left: 0.5rem;
            padding-right: 0.5rem;
        }
        
        .robot-header h1 {
            font-size: 1.3rem;
        }
        
        .dashboard-card {
            padding: 0.5rem;
        }
        
        .gradient-btn {
            font-size: 0.8rem;
            padding: 6px 12px;
        }
        
        .feature-card {
            padding: 0.5rem;
        }
    }
    
    /* Style pour le titre LuckyJet */
    .luckyjet-title {
        background: linear-gradient(135deg, #8a00e1, #ff69b4, #00ffff);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        text-shadow: 0 2px 10px rgba(138, 0, 225, 0.3);
    }
    </style>
</head>
<body class="text-white">

<!-- Syst√®me de notifications -->
<div id="notificationSystem"></div>

<!-- √âtoiles en arri√®re-plan -->
<div class="stars" id="stars"></div>

<!-- Interface principale -->
<div class="container mx-auto px-2 py-4" id="mainApp">
    <div class="robot-header text-center jet-glowing">
        <h1 class="text-3xl font-bold flex items-center justify-center flex-wrap">
            <i class="fas fa-rocket mr-2 floating"></i>
            <span class="luckyjet-title">LuckyJet Predictor Premium</span>
            <span class="ml-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white text-xs px-2 py-1 rounded-full">V3.0</span>
        </h1>
        <p class="mt-1 text-purple-200 text-sm">Intelligence Artificielle avec v√©rification de licence</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mt-4">
        <!-- Colonne principale -->
        <div class="lg:col-span-2">
            <div class="dashboard-card">
                <div class="auto-fetch-container">
                    <div class="auto-fetch-header flex justify-between items-center">
                        <div class="auto-fetch-title font-bold text-white text-sm">
                            <i class="fas fa-sync-alt mr-2"></i> R√©cup√©ration Automatique
                        </div>
                        <div class="auto-fetch-status text-gray-300 text-sm" id="autoFetchStatus">
                            <span class="auto-fetch-dot bg-red-500 rounded-full w-2 h-2 inline-block mr-1"></span>
                            <span>En attente de licence...</span>
                        </div>
                    </div>
                    
                    <div class="coefficients-display mt-3 bg-gray-900 rounded-lg p-3" id="coefficientsDisplay">
                        <p class="text-center text-gray-500 text-sm">V√©rification de la licence en cours...</p>
                    </div>
                    
                    <div class="flex gap-3 mt-3 flex-wrap">
                        <button onclick="startAutoFetch()" class="flex-1 gradient-btn min-w-[120px]">
                            <i class="fas fa-play mr-2"></i> D√©marrer
                        </button>
                        <button onclick="stopAutoFetch()" class="flex-1 bg-gradient-to-r from-red-500 to-rose-600 text-white py-2 rounded-lg hover:opacity-90 transition font-semibold text-sm min-w-[120px]">
                            <i class="fas fa-stop mr-2"></i> Arr√™ter
                        </button>
                        <button onclick="openAdvancedSettings()" class="flex-1 bg-gradient-to-r from-green-500 to-teal-600 text-white py-2 rounded-lg hover:opacity-90 transition font-semibold text-sm min-w-[120px]">
                            <i class="fas fa-cog mr-2"></i> Options
                        </button>
                    </div>
                </div>
                
                <div id="result" class="bg-gray-900 rounded-lg p-4 mt-4 border border-gray-800">
                    <div class="text-center text-gray-600">
                        Les pr√©dictions appara√Ætront ici automatiquement
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Colonne de droite -->
        <div>
            <div class="stats-card mb-4">
                <h3 class="text-lg font-bold text-white mb-3">
                    <i class="fas fa-chart-pie text-purple-400 mr-2"></i>
                    Statistiques Globales
                </h3>
                <div id="statsContainer" class="text-center">
                    <p id="totalPredictions" class="text-2xl font-bold text-purple-400">0</p>
                    <p id="predictionAccuracy" class="text-xl font-bold text-green-400 mt-1">0%</p>
                    <div class="grid grid-cols-3 gap-3 mt-3">
                        <div class="bg-green-900 p-2 rounded-lg">
                            <p class="text-lg font-bold text-green-400">‚úÖ</p>
                            <p class="text-xs text-gray-300">Valid√©es</p>
                            <p id="successCount" class="font-bold">0</p>
                        </div>
                        <div class="bg-red-900 p-2 rounded-lg">
                            <p class="text-lg font-bold text-red-400">‚ùå</p>
                            <p class="text-xs text-gray-300">√âchou√©es</p>
                            <p id="failedCount" class="font-bold">0</p>
                        </div>
                        <div class="bg-yellow-900 p-2 rounded-lg">
                            <p class="text-lg font-bold text-yellow-400">‚è≥</p>
                            <p class="text-xs text-gray-300">En attente</p>
                            <p id="pendingCount" class="font-bold">0</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="stats-card mb-4">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-lg font-bold text-white">
                        <i class="fas fa-brain text-indigo-400 mr-2"></i>
                        Analyse Intelligence
                    </h3>
                    <button onclick="analyzeHistoricalData()" class="bg-gradient-to-r from-purple-500 to-indigo-600 text-white px-2 py-1 rounded-lg text-xs hover:opacity-90 transition">
                        Actualiser
                    </button>
                </div>
                <div id="intelligentAnalysis" class="text-xs space-y-2">
                    <div class="animate-pulse text-gray-500">
                        En attente de donn√©es...
                    </div>
                </div>
            </div>
            
            <div class="dashboard-card">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-lg font-bold text-white">
                        <i class="fas fa-history text-purple-400 mr-2"></i>
                        Historique des Pr√©dictions
                    </h3>
                    <button id="toggleHistory" class="bg-gradient-to-r from-purple-500 to-indigo-600 text-white px-2 py-1 rounded-lg text-xs hover:opacity-90 transition" onclick="toggleHistoryVisibility()">
                        Masquer
                    </button>
                </div>
                <div id="predictionHistory" class="space-y-3 max-h-[400px] overflow-y-auto pr-1 text-sm"></div>
            </div>
        </div>
    </div>
    
    <!-- Section Fonctionnalit√©s -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
        <div class="feature-card">
            <div class="text-purple-400 text-2xl mb-2">
                <i class="fas fa-shield-alt"></i>
            </div>
            <h4 class="font-bold text-base text-white mb-1">Licence S√©curis√©e</h4>
            <p class="text-gray-300 text-sm">Acc√®s prot√©g√© par syst√®me de licence s√©curis√©e.</p>
        </div>
        
        <div class="feature-card">
            <div class="text-green-400 text-2xl mb-2">
                <i class="fas fa-robot"></i>
            </div>
            <h4 class="font-bold text-base text-white mb-1">IA Avanc√©e</h4>
            <p class="text-gray-300 text-sm">Algorithmes intelligents pour pr√©dire les multiplicateurs avec une pr√©cision optimale.</p>
        </div>
        
        <div class="feature-card">
            <div class="text-pink-400 text-2xl mb-2">
                <i class="fas fa-cogs"></i>
            </div>
            <h4 class="font-bold text-base text-white mb-1">Param√®tres Avanc√©s</h4>
            <p class="text-gray-300 text-sm">Personnalisez les modes d'analyse selon vos pr√©f√©rences.</p>
        </div>
    </div>
    
    <!-- Indicateur de statut -->
    <div class="mt-6 p-4 bg-gray-900 rounded-lg border border-gray-800">
        <div class="flex items-center justify-between">
            <div>
                <h3 class="font-bold text-white">
                    <i class="fas fa-info-circle text-purple-400 mr-2"></i>
                    Statut du Syst√®me
                </h3>
                <p class="text-sm text-gray-400" id="statusIndicator">
                    <i class="fas fa-sync fa-spin"></i> V√©rification de la licence...
                </p>
            </div>
            <div class="text-right">
                <p class="text-sm text-gray-400">Version: <span class="font-bold text-purple-400">Premium 3.0</span></p>
                <p class="text-xs text-gray-500">Licence requise</p>
            </div>
        </div>
    </div>
</div>

<footer class="bg-gray-900 text-white py-6 mt-8 border-t border-gray-800">
    <div class="container mx-auto px-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <h3 class="text-lg font-bold mb-3">LuckyJet Predictor</h3>
                <p class="text-gray-300 text-sm">Syst√®me de pr√©diction intelligent pour le jeu LuckyJet</p>
            </div>
            
            <div>
                <h4 class="font-bold text-base mb-3">Licence</h4>
                <p class="text-gray-300 text-sm">Ce produit n√©cessite une licence valide pour fonctionner.</p>
                <button onclick="window.location.href='accueil.html'" class="mt-2 gradient-btn text-sm px-3 py-1">
                    <i class="fas fa-shopping-cart mr-1"></i> Acheter une licence
                </button>
            </div>
        </div>
        <div class="border-t border-gray-700 mt-6 pt-6 text-center text-gray-400 text-sm">
            <p>&copy; 2024 LuckyJet Predictor Premium. Tous droits r√©serv√©s.</p>
        </div>
    </div>
</footer>

<script>
    // Variables globales
    let predictionHistory = JSON.parse(localStorage.getItem('predictionHistory')) || [];
    let statsChart = null;
    let isHistoryVisible = true;
    let autoCoefficients = [];
    let autoFetchInterval = null;
    let pendingVerification = [];
    let isAutoFetchActive = false;
    
    // Variables pour le contr√¥le des doublons
    let lastCoefficient = null;
    let lastFetchTime = null;
    
    // Fonction pour cr√©er les √©toiles en arri√®re-plan
    function createStars() {
        if (!window.checkLicenseBeforeOperation || !window.checkLicenseBeforeOperation()) return;
        
        const starsContainer = document.getElementById('stars');
        const numberOfStars = 100;
        
        for (let i = 0; i < numberOfStars; i++) {
            const star = document.createElement('div');
            star.classList.add('star');
            
            const x = Math.random() * 100;
            const y = Math.random() * 100;
            const size = Math.random() * 3;
            const duration = 2 + Math.random() * 4;
            const opacity = 0.2 + Math.random() * 0.8;
            
            star.style.left = `${x}%`;
            star.style.top = `${y}%`;
            star.style.width = `${size}px`;
            star.style.height = `${size}px`;
            star.style.setProperty('--duration', `${duration}s`);
            star.style.setProperty('--opacity', opacity);
            
            starsContainer.appendChild(star);
        }
    }

    // Fonction pour mettre √† jour l'heure actuelle
    function updateCurrentTime() {
        if (!window.checkLicenseBeforeOperation || !window.checkLicenseBeforeOperation()) return;
        
        const now = new Date();
        const hours = now.getHours().toString().padStart(2, '0');
        const minutes = now.getMinutes().toString().padStart(2, '0');
    }

    // Initialisation au chargement
    document.addEventListener('DOMContentLoaded', () => {
        // Attendre que Firebase soit initialis√©
        setTimeout(() => {
            if (window.isLicenseValid) {
                initializeInterface();
            }
        }, 1000);
    });

    // Initialiser l'interface apr√®s v√©rification de licence
    function initializeInterface() {
        createStars();
        updateCurrentTime();
        
        // Initialiser les donn√©es
        updatePredictionHistory();
        updateStatistics();
        analyzeHistoricalData();
        
        // Afficher le guide
        showGuide();
        
        // Mettre √† jour le statut
        const statusElement = document.getElementById('statusIndicator');
        if (statusElement) {
            statusElement.innerHTML = `<i class="fas fa-check-circle text-green-500"></i> Licence active - Pr√™t`;
        }
        
        const fetchStatus = document.getElementById('autoFetchStatus');
        if (fetchStatus) {
            fetchStatus.innerHTML = `
                <span class="bg-red-500 rounded-full w-2 h-2 inline-block mr-1"></span>
                <span>Inactif</span>
            `;
        }
    }

    // Fonction pour d√©marrer la r√©cup√©ration automatique
    function startAutoFetch() {
        if (!window.checkLicenseBeforeOperation || !window.checkLicenseBeforeOperation()) {
            Swal.fire({
                icon: 'error',
                title: 'Licence invalide',
                text: 'Votre licence n\'est pas valide ou a expir√©',
                confirmButtonColor: '#8a00e1'
            });
            return;
        }
        
        if (autoFetchInterval) return;
        
        isAutoFetchActive = true;
        const statusElement = document.getElementById('autoFetchStatus');
        statusElement.innerHTML = `
            <span class="bg-green-500 rounded-full w-2 h-2 inline-block mr-1"></span>
            <span>R√©cup√©ration en cours...</span>
            <span class="fetching-spinner ml-2 w-3 h-3 border-2 border-purple-500 border-t-transparent rounded-full inline-block animate-spin"></span>
        `;
        
        // D√©marrer imm√©diatement une premi√®re r√©cup√©ration
        fetchLatestCoefficient();
        
        // Puis configurer l'intervalle
        autoFetchInterval = setInterval(fetchLatestCoefficient, 5000);
        
        Swal.fire({
            icon: 'success',
            title: 'R√©cup√©ration d√©marr√©e',
            text: 'Les coefficients seront r√©cup√©r√©s automatiquement toutes les 5 secondes',
            timer: 2000,
            toast: true,
            position: 'top'
        });
    }
    
    // Fonction pour arr√™ter la r√©cup√©ration automatique
    function stopAutoFetch() {
        if (!window.checkLicenseBeforeOperation || !window.checkLicenseBeforeOperation()) return;
        
        if (autoFetchInterval) {
            clearInterval(autoFetchInterval);
            autoFetchInterval = null;
            isAutoFetchActive = false;
            
            // R√©initialiser les variables de contr√¥le des doublons
            lastCoefficient = null;
            lastFetchTime = null;
            
            const statusElement = document.getElementById('autoFetchStatus');
            statusElement.innerHTML = `
                <span class="bg-red-500 rounded-full w-2 h-2 inline-block mr-1"></span>
                <span>Inactif</span>
            `;
            
            Swal.fire({
                icon: 'info',
                title: 'R√©cup√©ration arr√™t√©e',
                timer: 1500,
                toast: true,
                position: 'top'
            });
        }
    }
    
    // R√âCUP√âRATION DES COEFFICIENTS
    async function fetchLatestCoefficient() {
        if (!window.checkLicenseBeforeOperation || !window.checkLicenseBeforeOperation()) {
            stopAutoFetch();
            return;
        }
        
        try {
            const apiURL = "https://crash-gateway-grm-cr.100hp.app/state";
            const headers = {
                'customer-id': '077dee8d-c923-4c02-9bee-757573662e69',
                'session-id': '95a987ef-72e1-4eaa-a598-64a157a44e75',
                'accept': 'application/json',
            };
            
            const response = await fetch(apiURL, { headers });
            if (!response.ok) throw new Error("Erreur API");

            const data = await response.json();
            const coefficient = data.stopCoefficients?.[0] ?? null;
            
            if (coefficient !== null) {
                const adjustedCoefficient = coefficient === 1.00 ? 1.01 : coefficient;
                const roundedCoefficient = parseFloat(adjustedCoefficient.toFixed(2));
                const now = Date.now();
                
                // V√©rifier si le coefficient est identique au pr√©c√©dent et dans un intervalle < 7s
                if (lastCoefficient === roundedCoefficient && lastFetchTime && (now - lastFetchTime) < 7000) {
                    // Afficher un avertissement temporaire
                    showDuplicateWarning();
                    return;
                }
                
                // Mettre √† jour les variables de contr√¥le
                lastCoefficient = roundedCoefficient;
                lastFetchTime = now;
                
                autoCoefficients.push(roundedCoefficient);
                updateCoefficientsDisplay();
                
                // V√©rification des pr√©dictions en attente
                verifyPendingPredictions(roundedCoefficient);
                
                // Si 5 coefficients, d√©clencher la pr√©diction
                if (autoCoefficients.length >= 5) {
                    predictOdds(true);
                    
                    setTimeout(() => {
                        autoCoefficients = [];
                        updateCoefficientsDisplay();
                    }, 1000);
                }
            }
        } catch (error) {
            console.error("Erreur lors de la r√©cup√©ration des coefficients:", error);
        }
    }
    
    function showDuplicateWarning() {
        const displayElement = document.getElementById('coefficientsDisplay');
        if (!displayElement.querySelector('.duplicate-warning')) {
            const warningElement = document.createElement('div');
            warningElement.className = 'duplicate-warning';
            warningElement.innerHTML = `
                <i class="fas fa-exclamation-triangle mr-2"></i>
                Coefficient identique d√©tect√© (ignor√©)
            `;
            displayElement.appendChild(warningElement);
            
            // Supprimer l'avertissement apr√®s 3 secondes
            setTimeout(() => {
                if (warningElement.parentNode) {
                    warningElement.parentNode.removeChild(warningElement);
                }
            }, 3000);
        }
    }
    
    // V√©rification des pr√©dictions en attente (5 rounds)
    function verifyPendingPredictions(newCoefficient) {
        const updatedPending = [];
        
        for (const pending of pendingVerification) {
            // V√©rifier si le nouveau coefficient valide la pr√©diction
            if (newCoefficient >= pending.predictedOdds) {
                // Succ√®s - mettre √† jour la pr√©diction
                const predictionIndex = predictionHistory.findIndex(p => p.id === pending.id);
                if (predictionIndex !== -1) {
                    predictionHistory[predictionIndex].verificationStatus = 'success';
                    predictionHistory[predictionIndex].verifiedRound = pending.currentRound;
                    predictionHistory[predictionIndex].status = 'success';
                    predictionHistory[predictionIndex].round = pending.currentRound;
                    localStorage.setItem('predictionHistory', JSON.stringify(predictionHistory));
                    updatePredictionHistory();
                    updateStatistics();
                    
                    // Afficher notification
                    Swal.fire({
                        icon: 'success',
                        title: 'Pr√©diction valid√©e!',
                        html: `La pr√©diction ${pending.predictedOdds} a √©t√© valid√©e au Round ${pending.currentRound}`,
                        toast: true,
                        position: 'top-end',
                        showConfirmButton: false,
                        timer: 3000
                    });
                }
            } else {
                // Incr√©menter le round
                pending.currentRound++;
                
                // V√©rifier si on a d√©pass√© le nombre de rounds √† v√©rifier (5 rounds max)
                if (pending.currentRound <= 5) {
                    updatedPending.push(pending);
                    
                    // Mettre √† jour l'historique
                    updatePredictionHistory();
                } else {
                    // √âchec apr√®s 5 rounds
                    const predictionIndex = predictionHistory.findIndex(p => p.id === pending.id);
                    if (predictionIndex !== -1) {
                        predictionHistory[predictionIndex].verificationStatus = 'failed';
                        predictionHistory[predictionIndex].status = 'failed';
                        
                        localStorage.setItem('predictionHistory', JSON.stringify(predictionHistory));
                        updatePredictionHistory();
                        updateStatistics();
                        
                        Swal.fire({
                            icon: 'error',
                            title: 'Pr√©diction √©chou√©e',
                            html: `La pr√©diction ${pending.predictedOdds} n'a pas √©t√© valid√©e dans les 5 rounds`,
                            toast: true,
                            position: 'top-end',
                            showConfirmButton: false,
                            timer: 3000
                        });
                    }
                }
            }
        }
        
        pendingVerification = updatedPending;
    }
    
    // Fonction pour mettre √† jour l'affichage des coefficients
    function updateCoefficientsDisplay() {
        const displayElement = document.getElementById('coefficientsDisplay');
        
        if (autoCoefficients.length === 0) {
            displayElement.innerHTML = '<p class="text-center text-gray-500 text-sm">Les coefficients appara√Ætront ici</p>';
            return;
        }
        
        displayElement.innerHTML = `
            <div class="flex flex-wrap justify-center">
                ${autoCoefficients.map(coef => `
                    <div class="coefficient-badge text-xs">${coef}X</div>
                `).join('')}
            </div>
            <div class="text-center mt-2 text-xs text-gray-400">
                ${5 - autoCoefficients.length} coefficient(s) restant(s) avant pr√©diction
            </div>
        `;
    }
    
    // FONCTION DE PR√âDICTION
    function predictOdds(autoTriggered = false) {
        if (!window.checkLicenseBeforeOperation || !window.checkLicenseBeforeOperation()) return;
        
        const settings = JSON.parse(localStorage.getItem('predictionSettings')) || {
            analysisMode: 'standard',
            excludeExtremes: false,
            trendAnalysis: false
        };

        // Utiliser les coefficients automatiques
        let oddsArray = [...autoCoefficients]
            .filter(odd => !isNaN(odd) && odd > 1);

        if (oddsArray.length < 5) {
            Swal.fire({
                icon: 'error',
                title: 'Donn√©es Insuffisantes',
                text: 'Veuillez attendre au moins 5 c√¥tes valides',
                confirmButtonColor: '#8a00e1',
                toast: true,
                position: 'top'
            });
            return;
        }

        if (settings.excludeExtremes) {
            oddsArray.sort((a, b) => a - b);
            oddsArray = oddsArray.slice(1, -1);
        }

        let averageOdds;
        switch(settings.analysisMode) {
            case 'advanced':
                const weights = oddsArray.map((_, i) => 1 + (i * 0.1));
                const weightedSum = oddsArray.reduce((acc, curr, i) => acc + (curr * weights[i]), 0);
                const weightSum = weights.reduce((acc, curr) => acc + curr, 0);
                averageOdds = weightedSum / weightSum;
                break;
            case 'pro':
                const trend = settings.trendAnalysis ? calculateTrend(oddsArray) : 1;
                averageOdds = (oddsArray.reduce((acc, curr) => acc + curr, 0) / oddsArray.length) * trend;
                break;
            default:
                averageOdds = oddsArray.reduce((acc, curr) => acc + curr, 0) / oddsArray.length;
        }

        const probabilities = oddsArray.map(odd => (1 / odd * 100).toFixed(2));

        const predictionResult = {
            id: Date.now(),
            date: new Date().toLocaleString(),
            averageOdds: averageOdds.toFixed(2),
            probabilities: probabilities,
            status: 'pending',
            originalOdds: oddsArray.join(', '),
            round: null,
            analysisMode: settings.analysisMode,
            verificationStatus: 'pending',
            verifiedRound: null,
            confidence: Math.round(Math.random() * 20 + 70) // Confiance entre 70-90%
        };

        // Ajouter √† la v√©rification automatique si d√©clench√© automatiquement
        if (autoTriggered && isAutoFetchActive) {
            pendingVerification.push({
                id: predictionResult.id,
                predictedOdds: parseFloat(predictionResult.averageOdds),
                currentRound: 1
            });
        }

        // Ajouter √† l'historique
        predictionHistory.unshift(predictionResult);
        localStorage.setItem('predictionHistory', JSON.stringify(predictionHistory));

        updatePredictionDisplay(predictionResult);
        updatePredictionHistory();
        updateStatistics();
        analyzeHistoricalData();

        Swal.fire({
            icon: 'success',
            title: 'Pr√©diction G√©n√©r√©e!',
            html: `
                <div class="text-left text-sm">
                    <p>Multiplicateur pr√©dit: <strong>${predictionResult.averageOdds}X</strong></p>
                    <p class="text-gray-300">Probabilit√©: ${predictionResult.probabilities[0]}%</p>
                    <p class="text-gray-300">Mode: ${settings.analysisMode}</p>
                </div>
            `,
            toast: true,
            position: 'top',
            showConfirmButton: false,
            timer: 3000
        });
    }

    function calculateTrend(oddsArray) {
        const firstHalf = oddsArray.slice(0, Math.floor(oddsArray.length / 2));
        const secondHalf = oddsArray.slice(Math.floor(oddsArray.length / 2));
        const firstAvg = firstHalf.reduce((acc, curr) => acc + curr, 0) / firstHalf.length;
        const secondAvg = secondHalf.reduce((acc, curr) => acc + curr, 0) / secondHalf.length;
        return 1 + ((secondAvg - firstAvg) / firstAvg);
    }
    
    function updatePredictionDisplay(prediction) {
        // Statut de v√©rification
        let verificationStatus = '';
        if (prediction.verificationStatus === 'pending') {
            const pendingInfo = pendingVerification.find(p => p.id === prediction.id);
            const currentRound = pendingInfo ? pendingInfo.currentRound : 1;
            
            verificationStatus = `
                <div class="validation-container">
                    <div class="validation-status validation-pending">
                        <i class="fas fa-sync-alt fa-spin mr-2"></i>
                        V√©rification en cours - Round ${currentRound}/5
                    </div>
                    <p class="text-xs text-center mt-2 text-gray-400">
                        Le syst√®me v√©rifie automatiquement cette pr√©diction sur les 5 prochains rounds
                    </p>
                </div>
            `;
        } else if (prediction.verificationStatus === 'success') {
            verificationStatus = `
                <div class="validation-container">
                    <div class="validation-status validation-success">
                        <i class="fas fa-check-circle mr-2"></i>
                        ‚úÖ Valid√© au Round ${prediction.verifiedRound}
                    </div>
                    <p class="text-xs text-center mt-2 text-green-400 font-medium">
                        Cette pr√©diction a √©t√© valid√©e avec succ√®s!
                    </p>
                </div>
            `;
        } else if (prediction.verificationStatus === 'failed') {
            verificationStatus = `
                <div class="validation-container">
                    <div class="validation-status validation-failed">
                        <i class="fas fa-times-circle mr-2"></i>
                        ‚ùå √âchou√© apr√®s 5 rounds
                    </div>
                    <p class="text-xs text-center mt-2 text-red-400 font-medium">
                        Cette pr√©diction n'a pas √©t√© valid√©e dans les 5 rounds
                    </p>
                </div>
            `;
        }
        
        document.getElementById('result').innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="text-center p-3 bg-gray-800 rounded-lg">
                    <span class="text-xs text-gray-400 block mb-1">Multiplicateur Pr√©dit</span>
                    <p class="text-2xl font-bold text-purple-400">${prediction.averageOdds}X</p>
                </div>
                
                <div class="text-center p-3 bg-gray-800 rounded-lg">
                    <span class="text-xs text-gray-400 block mb-1">Probabilit√© de R√©ussite</span>
                    <p class="text-2xl font-bold text-green-400">${prediction.probabilities[0]}%</p>
                </div>
            </div>
            
            <div class="mt-3">
                <div class="flex justify-between mb-1">
                    <span class="text-sm font-medium text-gray-300">Niveau de confiance</span>
                    <span class="text-sm font-medium text-gray-300">${prediction.confidence}%</span>
                </div>
                <div class="confidence-level w-full rounded-full h-2 bg-gray-700">
                    <div class="confidence-fill h-2 rounded-full" style="width: ${prediction.confidence}%"></div>
                </div>
            </div>
            
            ${verificationStatus}
        `;
    }
    
    function updatePredictionHistory() {
        const historyContainer = document.getElementById('predictionHistory');
        historyContainer.innerHTML = predictionHistory.map((prediction) => {
            // V√©rifier si cette pr√©diction est en cours de v√©rification
            const isPendingVerification = pendingVerification.some(p => p.id === prediction.id);
            const pendingInfo = pendingVerification.find(p => p.id === prediction.id);
            
            return `
            <div class="history-item p-3 rounded-lg">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-semibold text-white text-sm">${prediction.date}</p>
                                <p class="text-xs text-gray-400">
                                    Pr√©diction: <span class="font-bold text-purple-400">${prediction.averageOdds}X</span> 
                                    <span class="ml-1">(${prediction.probabilities[0]}%)</span>
                                </p>
                            </div>
                            <div>
                                ${prediction.status === 'pending' ? `
                                    <span class="status-badge status-pending text-xs">En attente</span>
                                ` : prediction.status === 'success' ? `
                                    <span class="status-badge status-success text-xs">Valid√©e</span>
                                ` : `
                                    <span class="status-badge status-failed text-xs">√âchou√©e</span>
                                `}
                            </div>
                        </div>
                        
                        <!-- Statut de v√©rification -->
                        ${isPendingVerification ? `
                            <div class="mt-2 text-xs bg-yellow-900 text-yellow-400 p-1.5 rounded">
                                <i class="fas fa-sync-alt fa-spin mr-1"></i>
                                V√©rification en cours: 
                                <span class="font-bold">Round ${pendingInfo.currentRound}/5</span>
                            </div>
                        ` : ''}
                        
                        ${prediction.verificationStatus === 'success' ? `
                            <div class="mt-2 text-xs bg-green-900 text-green-400 p-1.5 rounded">
                                <i class="fas fa-check-circle mr-1"></i>
                                Valid√© au Round ${prediction.verifiedRound}
                            </div>
                        ` : ''}
                        
                        ${prediction.verificationStatus === 'failed' ? `
                            <div class="mt-2 text-xs bg-red-900 text-red-400 p-1.5 rounded">
                                <i class="fas fa-times-circle mr-1"></i>
                                √âchou√© apr√®s 5 rounds
                            </div>
                        ` : ''}
                    </div>
                </div>
            </div>
            `;
        }).join('');
    }
    
    function updateStatistics() {
        const total = predictionHistory.length;
        const success = predictionHistory.filter(p => p.status === 'success').length;
        const failed = predictionHistory.filter(p => p.status === 'failed').length;
        const pending = predictionHistory.filter(p => p.status === 'pending').length;
        
        const accuracy = total > 0 
            ? ((success / total) * 100).toFixed(1)
            : '0';

        document.getElementById('totalPredictions').textContent = total;
        document.getElementById('predictionAccuracy').textContent = accuracy + '%';
        document.getElementById('successCount').textContent = success;
        document.getElementById('failedCount').textContent = failed;
        document.getElementById('pendingCount').textContent = pending;
    }
    
    function openAdvancedSettings() {
        if (!window.checkLicenseBeforeOperation || !window.checkLicenseBeforeOperation()) return;
        
        const currentSettings = JSON.parse(localStorage.getItem('predictionSettings')) || {
            analysisMode: 'standard',
            excludeExtremes: false,
            trendAnalysis: false
        };

        Swal.fire({
            title: 'Param√®tres Avanc√©s',
            html: `
                <div class="grid grid-cols-1 gap-3 text-sm">
                    <div class="text-left">
                        <label class="block text-gray-300 mb-1">Mode d'Analyse</label>
                        <select id="analysisMode" class="w-full p-2 bg-gray-800 border border-gray-700 rounded-lg text-white">
                            <option value="standard" ${currentSettings.analysisMode === 'standard' ? 'selected' : ''}>
                                Standard (Moyenne simple)
                            </option>
                            <option value="advanced" ${currentSettings.analysisMode === 'advanced' ? 'selected' : ''}>
                                Avanc√© (Pond√©ration adaptative)
                            </option>
                            <option value="pro" ${currentSettings.analysisMode === 'pro' ? 'selected' : ''}>
                                Professionnel (Analyse compl√®te)
                            </option>
                        </select>
                    </div>
                    <div class="text-left">
                        <label class="block text-gray-300 mb-1">Options d'Analyse</label>
                        <div class="space-y-1">
                            <label class="flex items-center p-1.5 bg-gray-800 rounded-lg hover:bg-gray-700 cursor-pointer">
                                <input type="checkbox" id="excludeExtremes" class="mr-2 h-4 w-4 text-purple-500" 
                                    ${currentSettings.excludeExtremes ? 'checked' : ''}>
                                Exclure les valeurs extr√™mes
                            </label>
                            <label class="flex items-center p-1.5 bg-gray-800 rounded-lg hover:bg-gray-700 cursor-pointer">
                                <input type="checkbox" id="trendAnalysis" class="mr-2 h-4 w-4 text-purple-500"
                                    ${currentSettings.trendAnalysis ? 'checked' : ''}>
                                Analyse tendancielle
                            </label>
                        </div>
                    </div>
                </div>
            `,
            background: '#1a1a2e',
            color: 'white',
            showCancelButton: true,
            confirmButtonText: 'Sauvegarder',
            cancelButtonText: 'Annuler',
            confirmButtonColor: '#8a00e1',
            cancelButtonColor: '#ff5555',
            preConfirm: () => {
                const settings = {
                    analysisMode: document.getElementById('analysisMode').value,
                    excludeExtremes: document.getElementById('excludeExtremes').checked,
                    trendAnalysis: document.getElementById('trendAnalysis').checked
                };
                localStorage.setItem('predictionSettings', JSON.stringify(settings));
                return settings;
            }
        }).then((result) => {
            if (result.isConfirmed) {
                Swal.fire({
                    icon: 'success',
                    title: 'Param√®tres sauvegard√©s',
                    toast: true,
                    position: 'top',
                    showConfirmButton: false,
                    timer: 1500
                });
            }
        });
    }
    
    function analyzeHistoricalData() {
        if (!window.checkLicenseBeforeOperation || !window.checkLicenseBeforeOperation()) return;
        
        const successfulPredictions = predictionHistory.filter(p => p.status === 'success');
        if (successfulPredictions.length === 0) {
            document.getElementById('intelligentAnalysis').innerHTML = `
                <div class="text-center text-gray-500 p-3 text-xs">
                    <i class="fas fa-database text-2xl text-gray-600 mb-2"></i>
                    <p>Pas encore assez de donn√©es pour l'analyse</p>
                </div>
            `;
            return;
        }

        // Analyser les plages de probabilit√©
        const percentageRanges = analyzePercentageRanges(successfulPredictions);
        const roundAnalysis = analyzeRounds(successfulPredictions);
        const oddsAnalysis = analyzeOddsRanges(successfulPredictions);

        document.getElementById('intelligentAnalysis').innerHTML = `
            <div class="space-y-3">
                <div class="p-2 bg-gray-800 rounded-lg">
                    <div class="font-bold text-purple-400 mb-1 text-sm">
                        <i class="fas fa-chart-line mr-1"></i>
                        Meilleur Intervalle de Probabilit√©
                    </div>
                    <p class="text-purple-300 text-xs">
                        ${percentageRanges.bestRange}% (${percentageRanges.bestCount} succ√®s)
                        <span class="block text-purple-400 text-xs">
                            Taux de r√©ussite: ${percentageRanges.successRate}%
                        </span>
                    </p>
                </div>

                <div class="p-2 bg-gray-800 rounded-lg">
                    <div class="font-bold text-green-400 mb-1 text-sm">
                        <i class="fas fa-flag-checkered mr-1"></i>
                        Round le Plus Performant
                    </div>
                    <p class="text-green-300 text-xs">
                        Round ${roundAnalysis.bestRound}
                        <span class="block text-green-400 text-xs">
                            (${roundAnalysis.roundCount} succ√®s sur ${roundAnalysis.totalForRound} pr√©dictions)
                        </span>
                    </p>
                </div>

                <div class="p-2 bg-gray-800 rounded-lg">
                    <div class="font-bold text-pink-400 mb-1 text-sm">
                        <i class="fas fa-trophy mr-1"></i>
                        Meilleurs Multiplicateurs
                    </div>
                    <p class="text-pink-300 text-xs">
                        ${oddsAnalysis.bestRange}X
                        <span class="block text-pink-400 text-xs">
                            (${oddsAnalysis.successCount} succ√®s)
                        </span>
                    </p>
                </div>

                <div class="text-center text-xs text-gray-500 mt-2">
                    Analyse bas√©e sur ${successfulPredictions.length} pr√©dictions r√©ussies
                </div>
            </div>
        `;
    }

    function analyzePercentageRanges(predictions) {
        const ranges = {};
        const allPredictions = predictionHistory.filter(p => p.status !== 'pending');

        allPredictions.forEach(pred => {
            const probability = parseFloat(pred.probabilities[0]);
            const rangeStart = Math.floor(probability / 10) * 10;
            const rangeKey = `${rangeStart}-${rangeStart + 10}`;
            
            if (!ranges[rangeKey]) {
                ranges[rangeKey] = { total: 0, success: 0 };
            }
            ranges[rangeKey].total++;
            if (pred.status === 'success') {
                ranges[rangeKey].success++;
            }
        });

        let bestRange = '';
        let bestCount = 0;
        let bestSuccessRate = 0;

        Object.entries(ranges).forEach(([range, stats]) => {
            const successRate = (stats.success / stats.total) * 100;
            if (stats.success > bestCount || (stats.success === bestCount && successRate > bestSuccessRate)) {
                bestRange = range;
                bestCount = stats.success;
                bestSuccessRate = successRate;
            }
        });

        return {
            bestRange,
            bestCount,
            successRate: bestSuccessRate.toFixed(1)
        };
    }

    function analyzeRounds(predictions) {
        const roundStats = {};
        const allPredictions = predictionHistory.filter(p => p.status !== 'pending' && p.round);

        allPredictions.forEach(pred => {
            if (!roundStats[pred.round]) {
                roundStats[pred.round] = { total: 0, success: 0 };
            }
            roundStats[pred.round].total++;
            if (pred.status === 'success') {
                roundStats[pred.round].success++;
            }
        });

        let bestRound = 0;
        let bestSuccessRate = 0;
        let roundCount = 0;
        let totalForRound = 0;

        Object.entries(roundStats).forEach(([round, stats]) => {
            const successRate = (stats.success / stats.total) * 100;
            if (successRate > bestSuccessRate || (successRate === bestSuccessRate && stats.success > roundCount)) {
                bestRound = round;
                bestSuccessRate = successRate;
                roundCount = stats.success;
                totalForRound = stats.total;
            }
        });

        return {
            bestRound,
            roundCount,
            totalForRound,
            successRate: bestSuccessRate.toFixed(1)
        };
    }

    function analyzeOddsRanges(predictions) {
        const ranges = {};
        predictions.forEach(pred => {
            const odds = parseFloat(pred.averageOdds);
            const rangeStart = Math.floor(odds * 2) / 2;
            const rangeKey = `${rangeStart.toFixed(1)}-${(rangeStart + 0.5).toFixed(1)}`;
            
            ranges[rangeKey] = (ranges[rangeKey] || 0) + 1;
        });

        let bestRange = '';
        let maxSuccess = 0;

        Object.entries(ranges).forEach(([range, count]) => {
            if (count > maxSuccess) {
                bestRange = range;
                maxSuccess = count;
            }
        });

        return {
            bestRange,
            successCount: maxSuccess
        };
    }

    function toggleHistoryVisibility() {
        const historyContainer = document.getElementById('predictionHistory');
        const toggleButton = document.getElementById('toggleHistory');
        isHistoryVisible = !isHistoryVisible;
        
        if (isHistoryVisible) {
            historyContainer.style.display = 'block';
            toggleButton.textContent = 'Masquer';
            toggleButton.classList.remove('bg-green-500');
            toggleButton.classList.add('bg-purple-500');
        } else {
            historyContainer.style.display = 'none';
            toggleButton.textContent = 'Afficher';
            toggleButton.classList.remove('bg-purple-500');
            toggleButton.classList.add('bg-green-500');
        }
    }
    
    function showGuide() {
        Swal.fire({
            title: 'üöÄ Guide du LuckyJet Predictor Premium',
            html: `
                <div class="text-left space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                    <div>
                        <h3 class="text-lg font-bold text-purple-400">üìò Compatibilit√©</h3>
                        <ul class="list-disc pl-5 text-sm text-gray-300">
                            <li>LuckyJet</li>
                            <li>Crash</li>
                            <li>Jeux avec progression exponentielle des gains</li>
                        </ul>
                    </div>

                    <div>
                        <h3 class="text-lg font-bold text-purple-400">üìù Syst√®me de Licence</h3>
                        <div class="bg-purple-900/30 p-3 rounded-lg text-sm text-gray-300">
                            <p class="font-bold mb-2">Fonctionnement :</p>
                            <ul class="list-disc pl-5">
                                <li>Licence active n√©cessaire</li>
                                <li>V√©rification automatique</li>
                            </ul>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-lg font-bold text-purple-400">‚öôÔ∏è Param√©trage Recommand√©</h3>
                        <div class="bg-purple-900/30 p-3 rounded-lg text-sm text-gray-300">
                            <p class="font-bold mb-2">Pour une pr√©cision optimale :</p>
                            <ul class="list-disc pl-5">
                                <li><span class="font-semibold">Mode d'Analyse :</span> Professionnel</li>
                                <li><span class="font-semibold">Options d'Analyse :</span> Exclure les valeurs extr√™mes</li>
                            </ul>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-lg font-bold text-purple-400">üé≤ Conditions d'Utilisation</h3>
                        <ul class="list-disc pl-5 text-sm text-gray-300">
                            <li>Minimum 5 coefficients r√©cup√©r√©s pour une pr√©diction</li>
                            <li>V√©rification automatique sur 5 rounds</li>
                            <li>Licence active requise</li>
                        </ul>
                    </div>

                    <div class="bg-gray-800 p-3 rounded-lg mt-4">
                        <p class="text-sm font-bold text-red-400">‚ö†Ô∏è Avertissement</p>
                        <p class="text-xs text-gray-400">Cet outil est une aide √† la d√©cision. Les paris comportent toujours des risques. Misez de mani√®re responsable.</p>
                    </div>
                </div>
            `,
            width: '600px',
            background: '#1a1a2e',
            color: 'white',
            confirmButtonText: 'J\'ai compris',
            confirmButtonColor: '#8a00e1'
        });
    }

    // Exposer les fonctions globalement
    window.fetchLatestCoefficient = fetchLatestCoefficient;
    window.createStars = createStars;
    window.updateCurrentTime = updateCurrentTime;
</script>
</body>
</html>